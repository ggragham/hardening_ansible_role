---
- block:
    - name: Remove default values in sshd_config
      replace:
        path: /etc/ssh/sshd_config
        regexp: ^\s*({{ item }}.*)
        replace: '# \1'
      with_items:
        - Port
        - PermitRootLogin
        - MaxAuthTries
        - MaxSessions
        - PasswordAuthentication
        - PermitEmptyPasswords
        - X11Forwarding
        - AuthorizedKeysFile
      become: true

    - name: Apply sshd config
      template:
        src: 01_ssh.conf.j2
        dest: /etc/ssh/sshd_config.d/01_ssh.conf
        mode: '0600'
      notify: Restart sshd
      become: true

    - name: Remove root password
      user:
        name: root
        state: present
        password_lock: true
      become: true
      when: SSH_REMOVE_ROOT_PASSWORD_ENABLED

    - name: Set passwordless sudo
      community.general.sudoers:
        name: users
        state: present
        user: '{{ USERNAME }}'
        commands: ALL
      become: true
      when: SSH_PASWORDLESS_SUDO_ENABLED
